# ü§ñ Robotarium Hub - Firmware (UCM)

Este directorio contiene el c√≥digo fuente del firmware para los robots de la plataforma **Robotarium Hub**. El sistema act√∫a como el controlador de bajo nivel (Low-Level Control) encargado de la ejecuci√≥n de comandos en tiempo real, telemetr√≠a y gesti√≥n de hardware.

## üìã Descripci√≥n T√©cnica
El firmware implementa un sistema de control diferencial robusto con las siguientes caracter√≠sticas:
* **Lazo de Control (100Hz):** Sincronizaci√≥n determinista cada 10ms para asegurar la estabilidad de los algoritmos de control.
* **Odometr√≠a:** Lectura de encoders de cuadratura mediante interrupciones (ISR) para m√°xima precisi√≥n.
* **Algoritmos de Control:** Implementaci√≥n de controladores PID + FeedForward para compensar fricciones y din√°micas del motor.
* **Comunicaci√≥n Dual:** * **Serial1:** Interfaz binaria de baja latencia con la Raspberry Pi.
    * **MQTT:** Supervisi√≥n y telemetr√≠a de alto nivel v√≠a WiFi.



## üõ†Ô∏è Requisitos de Hardware
* **Microcontrolador:** Arduino MKR WiFi 1010 o Arduino Nano 33 IoT.
* **Drivers de Motor:** Controladores PWM con pin de direcci√≥n.
* **Sensores:** Encoders de cuadratura (√≥pticos o magn√©ticos).

## üì¶ Librer√≠as Necesarias
Es necesario instalar las siguientes librer√≠as desde el **Library Manager** del Arduino IDE:
1. `WiFiNINA` - Gesti√≥n de conexi√≥n inal√°mbrica.
2. `ArduinoMqttClient` - Comunicaci√≥n con el broker MQTT.
3. `PID` (de Brett Beauregard o versi√≥n compatible incluida en el repo).

## üöÄ Instalaci√≥n y Configuraci√≥n

1. **Gesti√≥n de Secretos:**
   Renombra el archivo `arduino_secrets_template.h` a `arduino_secrets.h` e introduce tus credenciales:
   ```cpp
   #define SECRET_SSID "Nombre_De_Tu_Red"
   #define SECRET_PASS "Password_De_Tu_Red"
   
2. **Calibraci√≥n del Robot:**
   Ajusta las constantes f√≠sicas en `Robot.h` o `Robot.cpp` seg√∫n el modelo real. Estos valores son cr√≠ticos para que la odometr√≠a y las velocidades sean precisas:
   * `WHEEL_RADIUS`: Radio de la rueda en metros (ej. `0.0325`).
   * `ROBOT_DIAMETER`: Distancia entre los centros de ambas ruedas (track width).
   * `MAX_ENCODER_STEPS`: Pulsos por revoluci√≥n que entrega el encoder tras la reductora.

3. **Carga del C√≥digo:**
   Abre `Robot.ino` en el Arduino IDE, selecciona tu placa (familia MKR o Nano 33 IoT) y el puerto COM asignado. Pulsa **Upload**.

## üìë Diccionario de Operaciones (OP_CODES)

El robot procesa comandos binarios basados en la estructura `appdata`. Los c√≥digos de operaci√≥n (`op`) disponibles son:

| OP_CODE | Nombre | Descripci√≥n | Par√°metros |
| :--- | :--- | :--- | :--- |
| **100** | `OP_STOP` | Parada de emergencia inmediata. | Ninguno |
| **101** | `OP_MOVE` | Movimiento lineal de consigna. | Velocidad (m/s) |
| **102** | `OP_TURN` | Giro relativo sobre el eje central. | √Ångulo (grados) |
| **103** | `OP_CONF_PID` | Ajuste din√°mico de constantes Kp, Ki, Kd. | 6 valores double |
| **104** | `OP_CONF_FF` | Ajuste de FeedForward (Pendiente/Offset). | 4 valores double |
| **105** | `OP_TELEMETRY`| Solicitud de estado (Velocidad/Bater√≠a). | Ninguno |
| **106** | `OP_DONE` | ACK enviado por el robot al completar tarea. | - |
| **108** | `OP_ERROR` | Notificaci√≥n de fallo o comando inv√°lido. | - |



## üîß Soluci√≥n de Problemas (Troubleshooting)

| Problema | Causa probable | Soluci√≥n |
| :--- | :--- | :--- |
| **No hay respuesta Serial** | Cableado TX/RX incorrecto o Baudrate. | Cruza cables TX->RX y verifica 115200 baudios. |
| **Bucle "Checking WiFi"** | Credenciales mal configuradas o falta se√±al. | Revisa `arduino_secrets.h` y posici√≥n de antena. |
| **Fallo de Conexi√≥n MQTT** | Broker offline o IP incorrecta. | Verifica que el Broker MQTT corra en la Raspberry Pi. |
| **Giro en sentido opuesto** | Fase de motor o encoder invertida. | Intercambia los cables del motor o ajusta el signo en el c√≥digo. |
| **Error de InitFlag (112)** | Desincronizaci√≥n de trama binaria. | Asegura que la RPi termine cada paquete con '\n'. |

## üìÅ Estructura del Proyecto
* `Robot.ino`: Lazo principal (10ms) y rutinas de interrupci√≥n (ISR).
* `Robot.cpp/h`: Abstracci√≥n de hardware y cinem√°tica diferencial.
* `controller.cpp/h`: L√≥gica del PID y compensaci√≥n de errores.
* `common.h`: Estructuras de datos (`appdata`) sincronizadas con la Raspberry Pi.
* `operation.h`: Definici√≥n de protocolos y gestores de comandos (handlers).

---
**Desarrollado por:** Universidad Complutense de Madrid (UCM)  
**Repositorio Principal:** [github.com/UCM-237/robotarium-hub](https://github.com/UCM-237/robotarium-hub)
